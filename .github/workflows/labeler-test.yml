name: "Labeler Test"
on:
- pull_request

jobs:
  labeler-test:
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    env:
      CONFIGURATION_PATH: .github/labeler-test.yml
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: go mod tidy

      - name: Build
        run: go build ./...

      - uses: actions/labeler@v5
        id: labeler
        with:
          sync-labels: true
          configuration-path: ${{ env.CONFIGURATION_PATH }}
      - env:
          ALL_LABELS: ${{ steps.labeler.outputs.all-labels }}
        run: |
          echo "Labels: ${ALL_LABELS}"

      - name: Label-kit labeler
        id: label-kit-labeler
        run: |
          MATCHED_LABELS=$(go run . labeler \
            --config ${{ env.CONFIGURATION_PATH }} \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            ${{ github.event.number }})
          echo "labels=${MATCHED_LABELS}" | tee "${GITHUB_OUTPUT}"
      - name: Test
        env:
          LABELER_ALL_LABELS: ${{ steps.labeler.outputs.all-labels }}
          LABEL_KIT_ALL_LABELS: ${{ steps.label-kit-labeler.outputs.labels }}
        run: |
          LABELER_LABELS_SORTED=$(echo "${LABELER_ALL_LABELS}" | tr ',' '\n' | sort | tr '\n' ',' | sed 's/,$//')
          LABEL_KIT_LABELS_SORTED=$(echo "${LABEL_KIT_ALL_LABELS}" | tr ',' '\n' | sort | tr '\n' ',' | sed 's/,$//')
          echo "LABELER_LABELS_SORTED=${LABELER_LABELS_SORTED}"
          echo "LABEL_KIT_LABELS_SORTED=${LABEL_KIT_LABELS_SORTED}"
          test "${LABELER_LABELS_SORTED}" == "${LABEL_KIT_LABELS_SORTED}"

  sync-test:
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: go mod tidy

      - name: Build
        run: go build ./...

      - name: Label-kit sync-enable
        id: sync-enable
        run: |
          MATCHED_LABELS=$(go run . labeler \
            --config .github/labeler-sync-test-enable.yml \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            1)
          echo "labels=${MATCHED_LABELS}" | tee "${GITHUB_OUTPUT}"
      - name: Label-kit sync-disable
        id: sync-disable
        run: |
          MATCHED_LABELS=$(go run . labeler \
            --config .github/labeler-sync-test-disable.yml \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            1)
          echo "labels=${MATCHED_LABELS}" | tee "${GITHUB_OUTPUT}"
      - name: Test
        env:
          SYNC_ENABLE_LABELS: ${{ steps.sync-enable.outputs.labels }}
          SYNC_DISABLE_LABELS: ${{ steps.sync-disable.outputs.labels }}
        run: |
          test "${SYNC_ENABLE_LABELS}" == "sync-test"
          test "${SYNC_DISABLE_LABELS}" == ""

  codeowners-test:
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: go mod tidy

      - name: Build
        run: go build ./...

      #
      # Test that review requests cannot be sent to the author
      #
      - name: Set TARGET_PR_NUMBER 5
        run: echo "TARGET_PR_NUMBER=5" >> ${GITHUB_ENV}
      - &label-kit-codeowners-enable
        name: Label-kit codeowners-enable
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-enable.yml \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            "${TARGET_PR_NUMBER}"
      - &test-reviewers-empty
        name: Test reviewers (should have not reviewers)
        run: |
          REVIEWERS=$(gh pr view "${TARGET_PR_NUMBER}" --json reviewRequests --jq '.reviewRequests[].login')
          test "${REVIEWERS}" == ""
      - &label-kit-codeowners-disable
        name: Label-kit codeowners-disable
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-disable.yml \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            "${TARGET_PR_NUMBER}"

      #
      # Test that review requests invalid user are ignored
      #
      - name: Set TARGET_PR_NUMBER 5
        run: echo "TARGET_PR_NUMBER=5" >> ${GITHUB_ENV}
      - name: Label-kit codeowners-enable (invalid user)
        id: codeowners-invalid-user
        continue-on-error: true
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-invalid-user.yml \
            --sync \
            --format json --jq '[ .[].name ] | join(",")' \
            "${TARGET_PR_NUMBER}"
      - name: Test reviewers
        env:
          CODEOWNERS_INVALID_USER_OUTCOME: ${{ steps.codeowners-invalid-user.outcome }}
        run: |
          REVIEWERS=$(gh pr view "${TARGET_PR_NUMBER}" --json reviewRequests --jq '.reviewRequests[].login')
          test "${REVIEWERS}" == ""
          test "${CODEOWNERS_INVALID_USER_OUTCOME}" == "failure"
      - *label-kit-codeowners-disable

      #
      # Test that review requests
      #
      - name: Set TARGET_PR_NUMBER 21
        run: echo "TARGET_PR_NUMBER=21" >> ${GITHUB_ENV}
      - *label-kit-codeowners-disable
      - *label-kit-codeowners-enable
      - &test-reviewers-srz-zumix
        name: Test reviewers
        uses: srz-zumix/retry-run-action@40be8edc05d941572a6238c37c629cc408014d10 # v0.3.0
        with:
          run: |
            gh pr view "${TARGET_PR_NUMBER}" --json reviewRequests --jq '.reviewRequests[].login' | grep -q 'srz-zumix'
      - &remove-reviewer
        name: Remove reviewer
        run: |
          gh pr edit "${TARGET_PR_NUMBER}" --remove-reviewer srz-zumix
      - *label-kit-codeowners-enable
      - *test-reviewers-empty
      - name: Label-kit codeowners-enable (always request)
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-enable.yml \
            --sync \
            --review-request always \
            --format json --jq '[ .[].name ] | join(",")' \
            "${TARGET_PR_NUMBER}"
      - *test-reviewers-srz-zumix
      - name: Label-kit codeowners-enable (already requested)
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-enable.yml \
            --sync \
            --review-request always \
            --dry-run \
            "${TARGET_PR_NUMBER}" | tee ${{ runner.temp }}/output.txt
          if grep -q "Would request reviewers for PR" ${{ runner.temp }}/output.txt; then
            echo "Error: Would request reviewers even if already requested"
            exit 1
          fi
      - *remove-reviewer
      - *label-kit-codeowners-disable
      - *test-reviewers-empty
      - name: Label-kit codeowners-enable (none request)
        run: |
          go run . labeler \
            --config .github/labeler-codeowners-test-enable.yml \
            --sync \
            --review-request none \
            --format json --jq '[ .[].name ] | join(",")' \
            "${TARGET_PR_NUMBER}"
      - *test-reviewers-empty
      - *label-kit-codeowners-disable
