name: "Pull Request Labeler"
on:
- pull_request

jobs:
  labeler:
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    env:
      CONFIGURATION_PATH: .github/labeler-test.yml
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: go mod tidy

      - name: Build
        run: go build ./...

      - uses: actions/labeler@v5
        id: labeler
        with:
          sync-labels: true
          configuration-path: ${{ env.CONFIGURATION_PATH }}
      - run: |
          echo "Labels: ${{ steps.labeler.outputs.all-labels }}"

      - name: Label-kit labeler
        id: label-kit-labeler
        run: |
          MATCHED_LABELS=$(go run . labeler \
            --config ${{ env.CONFIGURATION_PATH }} \
            --sync true \
            --format json --jq '[ .[].name ] | join(",")' \
            ${{ github.event.number }})
          echo "labels=${MATCHED_LABELS}" | tee "${GITHUB_OUTPUT}"
      - name: Test
        run: |
          test [ "${{ steps.labeler.outputs.all-labels }}" == ${{ steps.label-kit-labeler.outputs.labels }}  ]
